-- 销售报表数据表
CREATE TABLE IF NOT EXISTS `fa_fzly_sales_report` (
`id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
`date` date NOT NULL COMMENT '日期',
`product_id` int(10) NOT NULL COMMENT '产品ID',
`product_name` varchar(100) NOT NULL COMMENT '产品名称',
`product_type` varchar(50) NOT NULL COMMENT '产品类型',
`channel` enum('offline','ota','mini_program','official') NOT NULL COMMENT '渠道',
`sales_num` int(10) NOT NULL DEFAULT 0 COMMENT '销售数量',
`sales_amount` decimal(10,2) NOT NULL DEFAULT 0.00 COMMENT '销售金额',
`refund_num` int(10) NOT NULL DEFAULT 0 COMMENT '退款数量',
`refund_amount` decimal(10,2) NOT NULL DEFAULT 0.00 COMMENT '退款金额',
`actual_sales` decimal(10,2) NOT NULL DEFAULT 0.00 COMMENT '实际销售额',
`createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
`updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
PRIMARY KEY (`id`) USING BTREE,
KEY `idx_date` (`date`),
KEY `idx_product` (`product_id`),
KEY `idx_channel` (`channel`),
KEY `idx_type` (`product_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='销售报表数据表';

-- 客流报表数据表
CREATE TABLE IF NOT EXISTS `fa_fzly_visitor_report` (
`id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
`date` datetime NOT NULL COMMENT '日期时间',
`entry_num` int(10) NOT NULL DEFAULT 0 COMMENT '入园人数',
`exit_num` int(10) NOT NULL DEFAULT 0 COMMENT '出园人数',
`current_num` int(10) NOT NULL DEFAULT 0 COMMENT '当前在场人数',
`staff_entry` int(10) NOT NULL DEFAULT 0 COMMENT '工作人员入场',
`onsite_ticket` int(10) NOT NULL DEFAULT 0 COMMENT '现场购票入场',
`ota_ticket` int(10) NOT NULL DEFAULT 0 COMMENT 'OTA购票入场',
`official_ticket` int(10) NOT NULL DEFAULT 0 COMMENT '官方购票入场',
`source_area` text COMMENT '客源地分布(JSON)',
`max_capacity` int(10) NOT NULL COMMENT '单日最大承载量',
`instant_max_capacity` int(10) NOT NULL COMMENT '瞬时最大承载量',
`createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
PRIMARY KEY (`id`) USING BTREE,
KEY `idx_date` (`date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客流报表数据表';

-- 设备运行报表数据表
CREATE TABLE IF NOT EXISTS `fa_fzly_device_report` (
`id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
`device_id` int(10) NOT NULL COMMENT '设备ID',
`device_name` varchar(100) NOT NULL COMMENT '设备名称',
`device_type` varchar(50) NOT NULL COMMENT '设备类型',
`date` datetime NOT NULL COMMENT '日期时间',
`status` enum('normal','warning','error') NOT NULL COMMENT '设备状态',
`operation_time` int(10) DEFAULT 0 COMMENT '运行时长(分钟)',
`fault_time` int(10) DEFAULT 0 COMMENT '故障时长(分钟)',
`fault_count` int(10) DEFAULT 0 COMMENT '故障次数',
`data_count` int(10) DEFAULT 0 COMMENT '处理数据量',
`createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
PRIMARY KEY (`id`) USING BTREE,
KEY `idx_device` (`device_id`),
KEY `idx_date` (`date`),
KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备运行报表数据表';

-- 报表定时发送配置表
CREATE TABLE IF NOT EXISTS `fa_fzly_report_schedule` (
`id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
`report_type` enum('sales','stock','visitor','device') NOT NULL COMMENT '报表类型',
`title` varchar(100) NOT NULL COMMENT '标题',
`frequency` enum('daily','weekly','monthly') NOT NULL COMMENT '发送频率',
`send_time` varchar(50) NOT NULL COMMENT '发送时间',
`receivers` text NOT NULL COMMENT '接收邮箱(JSON)',
`format` enum('excel','pdf') NOT NULL DEFAULT 'excel' COMMENT '文件格式',
`params` text COMMENT '报表参数(JSON)',
`status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态:0=禁用,1=启用',
`last_send_time` bigint(16) DEFAULT NULL COMMENT '最后发送时间',
`createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
`updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
PRIMARY KEY (`id`) USING BTREE,
KEY `idx_type` (`report_type`),
KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='报表定时发送配置表';

-- 自定义报表配置表
CREATE TABLE IF NOT EXISTS `fa_fzly_custom_report` (
`id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
`title` varchar(100) NOT NULL COMMENT '报表标题',
`data_source` enum('sales','stock','visitor','device') NOT NULL COMMENT '数据来源',
`fields` text NOT NULL COMMENT '报表字段(JSON)',
`filters` text COMMENT '过滤条件(JSON)',
`sort` text COMMENT '排序条件(JSON)',
`user_id` int(10) NOT NULL COMMENT '创建用户ID',
`is_public` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否公开:0=否,1=是',
`status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态:0=禁用,1=启用',
`createtime` bigint(16) DEFAULT NULL COMMENT '创建时间',
`updatetime` bigint(16) DEFAULT NULL COMMENT '更新时间',
PRIMARY KEY (`id`) USING BTREE,
KEY `idx_user` (`user_id`),
KEY `idx_source` (`data_source`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='自定义报表配置表';

-- 数据同步日志表
CREATE TABLE IF NOT EXISTS `fa_fzly_data_sync_log` (
`id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
`module` varchar(50) NOT NULL COMMENT '模块名称',
`sync_time` bigint(16) NOT NULL COMMENT '同步时间',
`data_count` int(10) DEFAULT 0 COMMENT '同步数据量',
`status` enum('success','fail') NOT NULL COMMENT '同步状态',
`message` text COMMENT '同步信息',
`duration` int(10) DEFAULT 0 COMMENT '同步耗时(毫秒)',
PRIMARY KEY (`id`) USING BTREE,
KEY `idx_module` (`module`),
KEY `idx_time` (`sync_time`),
KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据同步日志表';


-- 销售报表测试数据
INSERT INTO `fa_fzly_sales_report`
(`date`, `product_id`, `product_name`, `product_type`, `channel`, `sales_num`, `sales_amount`, `refund_num`, `refund_amount`, `actual_sales`, `createtime`, `updatetime`)
VALUES
('2023-10-01', 1, '成人票', 'ticket', 'offline', 150, 15000.00, 5, 500.00, 14500.00, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('2023-10-01', 1, '成人票', 'ticket', 'ota', 80, 8000.00, 2, 200.00, 7800.00, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('2023-10-01', 1, '成人票', 'ticket', 'mini_program', 60, 6000.00, 1, 100.00, 5900.00, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('2023-10-01', 2, '儿童票', 'ticket', 'offline', 40, 2000.00, 0, 0.00, 2000.00, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('2023-10-02', 1, '成人票', 'ticket', 'offline', 130, 13000.00, 3, 300.00, 12700.00, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('2023-10-02', 1, '成人票', 'ticket', 'ota', 75, 7500.00, 1, 100.00, 7400.00, UNIX_TIMESTAMP(), UNIX_TIMESTAMP());

-- 客流报表测试数据
INSERT INTO `fa_fzly_visitor_report`
(`date`, `entry_num`, `exit_num`, `current_num`, `staff_entry`, `onsite_ticket`, `ota_ticket`, `official_ticket`, `source_area`, `max_capacity`, `instant_max_capacity`, `createtime`)
VALUES
('2023-10-01 09:00:00', 120, 0, 120, 10, 80, 20, 10, '{"beijing":30,"shanghai":25,"guangzhou":15,"other":50}', 5000, 2000, UNIX_TIMESTAMP()),
('2023-10-01 10:00:00', 250, 30, 340, 5, 150, 70, 25, '{"beijing":80,"shanghai":60,"guangzhou":40,"other":160}', 5000, 2000, UNIX_TIMESTAMP()),
('2023-10-01 11:00:00', 300, 80, 560, 5, 180, 90, 25, '{"beijing":120,"shanghai":90,"guangzhou":60,"other":290}', 5000, 2000, UNIX_TIMESTAMP()),
('2023-10-01 12:00:00', 180, 200, 540, 0, 100, 60, 20, '{"beijing":110,"shanghai":85,"guangzhou":55,"other":290}', 5000, 2000, UNIX_TIMESTAMP());

-- 设备运行报表测试数据
INSERT INTO `fa_fzly_device_report`
(`device_id`, `device_name`, `device_type`, `date`, `status`, `operation_time`, `fault_time`, `fault_count`, `data_count`, `createtime`)
VALUES
(1, '闸机1号', 'gate', '2023-10-01 08:00:00', 'normal', 120, 0, 0, 150, UNIX_TIMESTAMP()),
(2, '闸机2号', 'gate', '2023-10-01 08:00:00', 'normal', 120, 0, 0, 130, UNIX_TIMESTAMP()),
(3, '自助售票机1', 'ticket_machine', '2023-10-01 08:00:00', 'warning', 110, 10, 1, 80, UNIX_TIMESTAMP()),
(4, '监控设备1', 'monitor', '2023-10-01 08:00:00', 'normal', 120, 0, 0, 0, UNIX_TIMESTAMP());

-- 报表定时发送配置测试数据
INSERT INTO `fa_fzly_report_schedule`
(`report_type`, `title`, `frequency`, `send_time`, `receivers`, `format`, `params`, `status`, `last_send_time`, `createtime`, `updatetime`)
VALUES
('sales', '每日销售报表', 'daily', '09:00', '["manager@example.com","finance@example.com"]', 'excel', '{"type":"daily","channel":"all"}', 1, UNIX_TIMESTAMP()-3600*12, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('visitor', '每周客流分析', 'weekly', '10:00', '["operation@example.com"]', 'pdf', '{"type":"weekly","area":"all"}', 1, UNIX_TIMESTAMP()-3600*24*3, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('stock', '月度库存报表', 'monthly', '15:00', '["inventory@example.com","manager@example.com"]', 'excel', '{"type":"monthly","product_type":"all"}', 1, UNIX_TIMESTAMP()-3600*24*10, UNIX_TIMESTAMP(), UNIX_TIMESTAMP());

-- 自定义报表配置测试数据
INSERT INTO `fa_fzly_custom_report`
(`title`, `data_source`, `fields`, `filters`, `sort`, `user_id`, `is_public`, `status`, `createtime`, `updatetime`)
VALUES
('OTA渠道销售分析', 'sales', '["date","product_name","sales_num","sales_amount","refund_num"]', '{"channel":"ota","product_type":"ticket"}', '{"date":"desc"}', 1, 1, 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
('周末客流统计', 'visitor', '["date","entry_num","exit_num","current_num","staff_entry","onsite_ticket"]', '{"weekend":true}', '{"date":"asc"}', 1, 0, 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP());

-- 数据同步日志测试数据
INSERT INTO `fa_fzly_data_sync_log`
(`module`, `sync_time`, `data_count`, `status`, `message`, `duration`)
VALUES
('ticket', UNIX_TIMESTAMP()-300, 1500, 'success', '售票数据同步完成', 2000),
('checkin', UNIX_TIMESTAMP()-240, 850, 'success', '检票数据同步完成', 1500),
('inventory', UNIX_TIMESTAMP()-180, 320, 'success', '库存数据同步完成', 1200),
('finance', UNIX_TIMESTAMP()-120, 0, 'fail', '财务数据同步失败: 连接超时', 5000),
('ticket', UNIX_TIMESTAMP()-60, 200, 'success', '售票数据同步完成', 1800);

-- 插入今日客流数据测试记录
INSERT INTO `fa_fzly_visitor_report`
(`date`, `entry_num`, `exit_num`, `current_num`, `staff_entry`, `onsite_ticket`, `ota_ticket`, `official_ticket`, `source_area`, `max_capacity`, `instant_max_capacity`, `createtime`)
VALUES
(NOW(), 1250, 980, 270, 50, 450, 500, 250, '{"北京":300,"上海":200,"广州":150,"其他":600}', 5000, 1000, UNIX_TIMESTAMP()),
(DATE_SUB(NOW(), INTERVAL 1 HOUR), 1100, 850, 250, 45, 400, 450, 205, '{"北京":280,"上海":180,"广州":130,"其他":510}', 5000, 1000, UNIX_TIMESTAMP()-3600),
(DATE_SUB(NOW(), INTERVAL 2 HOUR), 950, 700, 250, 40, 350, 400, 160, '{"北京":250,"上海":160,"广州":110,"其他":430}', 5000, 1000, UNIX_TIMESTAMP()-7200);
{extend name="common/base" /}
{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">
        <h3 class="layui-card-title">退单管理</h3>
        <div class="layui-btn-group layui-card-header-toolbar">
            <a href="javascript:location.reload();" class="layui-btn layui-btn-primary layui-btn-sm"><i class="fa fa-refresh"></i> 刷新</a>
        </div>
    </div>
    <div class="layui-card-body">
        <form class="layui-form" lay-filter="searchForm">
            <div class="layui-form-item">
                <div class="layui-input-inline">
                    <input type="text" name="refund_no" placeholder="退单号" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-input-inline">
                    <input type="text" name="order_no" placeholder="原订单号" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-input-inline">
                    <input type="text" name="user.username" placeholder="用户名称" autocomplete="off" class="layui-input">
                </div>
                <div class="layui-input-inline">
                    <select name="order_type">
                        <option value="">订单类型</option>
                        {foreach name="orderTypeList" item="vo" key="k"}
                        <option value="{$k}">{$vo}</option>
                        {/foreach}
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select name="status">
                        <option value="">状态</option>
                        {foreach name="statusList" item="vo" key="k"}
                        <option value="{$k}">{$vo}</option>
                        {/foreach}
                    </select>
                </div>
                <button class="layui-btn" lay-submit lay-filter="search"><i class="fa fa-search"></i> 搜索</button>
                <button type="reset" class="layui-btn layui-btn-primary"><i class="fa fa-refresh"></i> 重置</button>
            </div>
        </form>

        <div class="layui-btn-group">
            <button class="layui-btn layui-btn-danger" id="batchDelete"><i class="fa fa-trash"></i> 批量删除</button>
        </div>

        <table class="layui-table" lay-size="sm" id="table" lay-filter="table"></table>
    </div>
</div>

<!-- 批量退单确认框 -->
<div id="batchRefundModal" style="display: none;">
    <form class="layui-form" lay-filter="batchRefundForm">
        <div class="layui-form-item">
            <label class="layui-form-label">退款原因</label>
            <div class="layui-input-block">
                <textarea name="refund_reason" class="layui-textarea" required placeholder="请输入退款原因"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="doBatchRefund">确认提交</button>
                <button type="button" class="layui-btn layui-btn-primary" id="cancelBatchRefund">取消</button>
            </div>
        </div>
    </form>
</div>
{/block}

{block name="script"}
<script>
    layui.use(['form', 'table', 'layer'], function(){
        var form = layui.form;
        var table = layui.table;
        var layer = layui.layer;
        var $ = layui.$;

        // 渲染表格
        var tableIns = table.render({
            elem: '#table',
            url: '{:url("index")}',
            page: true,
            limit: 10,
            limits: [10, 20, 30, 50],
            cols: [[
                {type: 'checkbox', fixed: 'left'},
                {field: 'refund_no', title: '退单号', width: 180},
                {field: 'order.order_no', title: '原订单号', width: 180},
                {field: 'user.username', title: '用户', width: 120},
                {field: 'order_type', title: '订单类型', width: 100, templet: function(d){
                        return '{:json_encode($orderTypeList)}'[d.order_type] || '';
                    }},
                {field: 'refund_amount', title: '申请退款金额', width: 120, templet: function(d){
                        return '¥' + d.refund_amount;
                    }},
                {field: 'fee_amount', title: '手续费', width: 100, templet: function(d){
                        return '¥' + d.fee_amount;
                    }},
                {field: 'actual_amount', title: '实际退款金额', width: 120, templet: function(d){
                        return '¥' + d.actual_amount;
                    }},
                {field: 'status', title: '状态', width: 100, templet: function(d){
                        var statusList = {:json_encode($statusList)};
                        var color = '';
                        switch(d.status){
                            case 1: color = 'layui-btn-normal'; break;
                            case 2: color = 'layui-btn-warm'; break;
                            case 3: color = 'layui-btn-danger'; break;
                            case 4: color = 'layui-btn-success'; break;
                            case 5: color = 'layui-btn-primary'; break;
                        }
                        return '<span class="layui-btn ' + color + ' layui-btn-xs">' + (statusList[d.status] || '') + '</span>';
                    }},
                {field: 'admin_name', title: '处理人', width: 100},
                {field: 'create_time', title: '申请时间', width: 160},
                {field: 'handle_time', title: '处理时间', width: 160},
                {fixed: 'right', title: '操作', width: 200, align: 'center', toolbar: '#tableBar'}
            ]],
            text: {
                none: '暂无相关数据'
            }
        });

        // 搜索
        form.on('submit(search)', function(data){
            tableIns.reload({
                where: data.field,
                page: {curr: 1}
            });
            return false;
        });

        // 工具条事件
        table.on('tool(table)', function(obj){
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'detail') {
                // 查看详情
                parent.$.fn.layerOpen({
                    title: '退单详情',
                    area: ['800px', '600px'],
                    content: '{:url("detail")}?ids=' + data.id
                });
            } else if (layEvent === 'handle') {
                // 处理退单
                parent.$.fn.layerOpen({
                    title: '处理退单',
                    area: ['700px', '500px'],
                    content: '{:url("handle")}?ids=' + data.id
                });
            } else if (layEvent === 'delete') {
                // 删除
                layer.confirm('确定要删除这条退单记录吗？', function(index){
                    $.post('{:url("delete")}', {ids: data.id}, function(res){
                        if (res.code === 1) {
                            obj.del();
                            layer.close(index);
                            layer.msg(res.msg, {icon: 1});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'json');
                });
            }
        });

        // 批量删除
        $('#batchDelete').click(function(){
            var checkStatus = table.checkStatus('table');
            var ids = checkStatus.data.map(function(item){
                return item.id;
            });

            if (ids.length === 0) {
                layer.msg('请选择要删除的记录', {icon: 2});
                return;
            }

            layer.confirm('确定要删除选中的 ' + ids.length + ' 条记录吗？', function(index){
                $.post('{:url("delete")}', {ids: ids.join(',')}, function(res){
                    if (res.code === 1) {
                        tableIns.reload();
                        layer.close(index);
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                }, 'json');
            });
        });
    });
</script>

<!-- 表格工具条 -->
<script type="text/html" id="tableBar">
    <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
    {{#  if(d.status == 1){ }}
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="handle">处理</a>
    {{#  } }}
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
</script>
{/block}
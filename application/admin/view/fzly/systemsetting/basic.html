{extend name="common/base" /}
{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">
        <h3 class="layui-card-title">基础参数配置</h3>
    </div>
    <div class="layui-card-body">
        <form class="layui-form" id="basicForm" enctype="multipart/form-data" method="post">
            <div class="layui-form-item">
                <label class="layui-form-label required">景区名称</label>
                <div class="layui-input-block">
                    <input type="text" name="scenic_name" value="{$basicInfo.scenic_name|default=''}"
                           class="layui-input" lay-verify="required" placeholder="请输入景区名称">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">系统名称</label>
                <div class="layui-input-block">
                    <input type="text" name="system_name" value="{$basicInfo.system_name|default='景区票务系统'}"
                           class="layui-input" lay-verify="required" placeholder="请输入系统名称">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">LOGO上传</label>
                <div class="layui-input-block">
                    <input type="file" name="logo" class="layui-upload-file" accept="image/png,image/jpg,image/jpeg" lay-verify="file">
                    {if $basicInfo.logo}
                    <div class="layui-upload-list" style="margin-top:10px;">
                        <img src="{$basicInfo.logo}" style="width:100px;height:auto;" alt="景区LOGO">
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" id="delLogo">删除当前LOGO</button>
                    </div>
                    {/if}
                    <p class="layui-form-mid layui-word-aux">支持PNG/JPG/JPEG格式，大小不超过5MB</p>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">联系电话</label>
                <div class="layui-input-block">
                    <input type="text" name="contact_phone" value="{$basicInfo.contact_phone|default=''}"
                           class="layui-input" lay-verify="required|phone" placeholder="请输入11位手机号">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">详细地址</label>
                <div class="layui-input-block">
                    <input type="text" name="address" value="{$basicInfo.address|default=''}"
                           class="layui-input" lay-verify="required" placeholder="请输入详细地址">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">ICP备案号</label>
                <div class="layui-input-block">
                    <input type="text" name="icp" value="{$basicInfo.icp|default=''}"
                           class="layui-input" placeholder="请输入ICP备案号">
                </div>
            </div>

            <fieldset class="layui-elem-field">
                <legend>系统参数设置</legend>
                <div class="layui-field-box">
                    <div class="layui-form-item">
                        <label class="layui-form-label required">数据刷新间隔</label>
                        <div class="layui-input-block">
                            <input type="number" name="refresh_interval"
                                   value="{$basicInfo.refresh_interval|default=5}"
                                   class="layui-input"
                                   lay-verify="required|number|min:1|max:60"
                                   placeholder="请输入1-60之间的整数（秒）">
                            <p class="layui-form-mid layui-word-aux">设置系统自动刷新数据的时间间隔</p>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label required">登录验证码</label>
                        <div class="layui-input-block">
                            <input type="radio" name="login_captcha" value="1" title="启用"
                                   {if $basicInfo.login_captcha == 1}checked{/if}>
                            <input type="radio" name="login_captcha" value="0" title="禁用"
                                   {if $basicInfo.login_captcha == 0}checked{/if}>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label required">操作日志记录</label>
                        <div class="layui-input-block">
                            <input type="radio" name="operation_log" value="1" title="启用"
                                   {if $basicInfo.operation_log == 1}checked{/if}>
                            <input type="radio" name="operation_log" value="0" title="禁用"
                                   {if $basicInfo.operation_log == 0}checked{/if}>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label required">默认语言</label>
                        <div class="layui-input-block">
                            <select name="default_lang" lay-verify="required">
                                {foreach name="langOptions" item="lang"}
                                <option value="{$lang.id}" {if $basicInfo.default_lang == $lang.id}selected{/if}>
                                {$lang.name}
                                </option>
                                {/foreach}
                            </select>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label required">时间显示格式</label>
                        <div class="layui-input-block">
                            <input type="text" name="time_format"
                                   value="{$basicInfo.time_format|default='Y-m-d H:i:s'}"
                                   class="layui-input"
                                   lay-verify="required"
                                   placeholder="例如: Y-m-d H:i:s">
                            <p class="layui-form-mid layui-word-aux">PHP时间格式，如Y-m-d H:i:s表示2024-09-01 12:00:00</p>
                        </div>
                    </div>

                    <div class="layui-btn-group layui-card-header-toolbar">
                        <button type="button" class="layui-btn layui-btn-normal" id="saveBtn"><i class="fa fa-save"></i> 保存配置</button>
                        <button class="layui-btn layui-btn-primary" id="resetBtn"><i class="fa fa-refresh"></i> 重置</button>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>
</div>
{/block}

{block name="script"}
<script>
    layui.use(['form', 'layer'], function(){
        var form = layui.form,
            layer = layui.layer;

        // 保存配置
        $('#saveBtn').click(function(e){
            // 阻止按钮默认提交行为（关键修复）
            e.preventDefault();
            form.validate(function(valid){
                if(valid){
                    console.log('表单验证通过，提交数据');
                    $.ajax({
                        url: '{:url("fzly.Systemsetting/basic")}',
                        type: 'post',
                        data: new FormData($('#basicForm')[0]),
                        processData: false,
                        contentType: false,
                        success: function(res){
                            if(res.code == 1){
                                layer.msg(res.msg, {icon:1}, function(){
                                    location.reload();
                                });
                            }else{
                                layer.msg(res.msg, {icon:2});
                            }
                        },
                        error: function(xhr, status, error){
                            console.error('请求错误:', error);
                            layer.msg('保存失败，网络错误', {icon:2});
                        }
                    });
                }else{
                    // 新增验证失败提示
                    layer.msg('表单验证失败，请检查输入项', {icon:2});
                    return false;
                }
            });
            // 额外保险：阻止事件冒泡
            return false;

        // 重置
        $('#resetBtn').click(function(){
            if(confirm('确定要重置表单吗？未保存的内容将会丢失！')){
                $('#basicForm')[0].reset();
                form.render();
            }
        });
    });
    })

    // 删除当前LOGO
    $('#delLogo').click(function(){
        layer.confirm('确定要删除当前LOGO吗？', {icon:3}, function(index){
            $.ajax({
                url: '{:url("fzly.Systemsetting/del_logo")}',
                type: 'post',
                success: function(res){
                    if(res.code == 1){
                        layer.msg('LOGO已删除', {icon:1}, function(){
                            location.reload();
                        });
                    }else{
                        layer.msg(res.msg, {icon:2});
                    }
                }
            });
            layer.close(index);
        });
    });
</script>
{/block}
{extend name="common/base" /}
{block name="content"}
<style>
    .dashboard-container {
        background-color: #0f1733;
        color: #fff;
        min-height: 100vh;
        padding: 20px;
    }
    .stat-card {
        background: rgba(30, 42, 84, 0.8);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid rgba(56, 107, 255, 0.3);
    }
    .stat-title {
        color: #86909c;
        font-size: 14px;
        margin-bottom: 10px;
    }
    .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #fff;
    }
    .stat-trend {
        font-size: 12px;
        margin-top: 5px;
    }
    .up {
        color: #ff4d4f;
    }
    .down {
        color: #52c41a;
    }
    .chart-container {
        background: rgba(30, 42, 84, 0.8);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        height: 350px;
        border: 1px solid rgba(56, 107, 255, 0.3);
    }
    .header-title {
        font-size: 24px;
        text-align: center;
        margin-bottom: 30px;
        color: #fff;
    }
    .capacity-bar {
        height: 10px;
        background-color: rgba(56, 107, 255, 0.2);
        border-radius: 5px;
        margin-top: 10px;
        overflow: hidden;
    }
    .capacity-fill {
        height: 100%;
        background-color: #386bff;
        border-radius: 5px;
    }
</style>

<div class="dashboard-container">
    <h1 class="header-title">景区运营数据大屏</h1>

    <div class="row">
        <!-- 今日入场总数据 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">今日总入场</div>
                <div class="stat-value">{$todayData.total_entry}</div>
                <div class="stat-trend up">较昨日 +12.5%</div>
            </div>
        </div>

        <!-- 今日出场 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">今日总出场</div>
                <div class="stat-value">{$todayData.exit_num}</div>
                <div class="stat-trend up">较昨日 +10.2%</div>
            </div>
        </div>

        <!-- 当前在场 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">当前在场人数</div>
                <div class="stat-value">{$todayData.current_num}</div>
                <div class="stat-trend">更新于 {date('H:i')}</div>
            </div>
        </div>

        <!-- 承载率 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">今日承载率</div>
                <div class="stat-value">{$todayData.capacity_usage}%</div>
                <div class="capacity-bar">
                    <div class="capacity-fill" style="width: {$todayData.capacity_usage}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 工作人员入场 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">工作人员入场</div>
                <div class="stat-value">{$todayData.staff_entry}</div>
            </div>
        </div>

        <!-- 现场购票入场 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">现场购票入场</div>
                <div class="stat-value">{$todayData.onsite_ticket}</div>
            </div>
        </div>

        <!-- OTA购票入场 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">OTA购票入场</div>
                <div class="stat-value">{$todayData.ota_ticket}</div>
            </div>
        </div>

        <!-- 官方购票入场 -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-title">官方购票入场</div>
                <div class="stat-value">{$todayData.official_ticket}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 承载量信息 -->
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-title">单日最大承载量</div>
                <div class="stat-value">{$todayData.max_capacity}</div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-title">瞬时最大承载量</div>
                <div class="stat-value">{$todayData.instant_max_capacity}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 时段流量图表 -->
        <div class="col-md-8">
            <div class="chart-container">
                <h3>今日时段流量趋势</h3>
                <div id="hourly-chart" style="width: 100%; height: 300px;"></div>
            </div>
        </div>

        <!-- 客源地分布 -->
        <div class="col-md-4">
            <div class="chart-container">
                <h3>客源地分布</h3>
                <div id="source-chart" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script src="__CDN__/assets/js/echarts.min.js"></script>
<script>
    // 初始化时段流量图表
    var hourlyChart = echarts.init(document.getElementById('hourly-chart'));
    var hourlyOption = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['入场人数', '出场人数'],
            textStyle: {color: '#fff'}
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: {$hourlyData.time|json_encode},
            axisLine: {
                lineStyle: {color: '#86909c'}
            },
            axisLabel: {
                color: '#86909c'
            }
        },
        yAxis: {
            type: 'value',
            axisLine: {
                lineStyle: {color: '#86909c'}
            },
            axisLabel: {
                color: '#86909c'
            }
        },
        series: [
            {
                name: '入场人数',
                type: 'line',
                data: {$hourlyData.entry|json_encode},
                lineStyle: {color: '#386bff'},
                itemStyle: {color: '#386bff'}
            },
            {
                name: '出场人数',
                type: 'line',
                data: {$hourlyData.exit|json_encode},
                lineStyle: {color: '#52c41a'},
                itemStyle: {color: '#52c41a'}
            }
        ]
    };
    hourlyChart.setOption(hourlyOption);

    // 初始化客源地分布图表
    var sourceChart = echarts.init(document.getElementById('source-chart'));
    var sourceOption = {
        tooltip: {
            trigger: 'item'
        },
        legend: {
            orient: 'vertical',
            left: 10,
            textStyle: {color: '#fff'}
        },
        series: [
            {
                name: '客源地',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#0f1733',
                    borderWidth: 2
                },
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: '16',
                        fontWeight: 'bold',
                        color: '#fff'
                    }
                },
                labelLine: {
                    show: false
                },
                data: [
                    {php}$total = count($sourceData['area']);{/php}  <!-- 计算数组总长度 -->
                    {foreach name="sourceData.area" item="area" key="key" index="i"}  <!-- 定义索引i -->
                    {
                        value: {$sourceData.num[$key]},
                        name: '{$area}'
                    }{if $i < $total - 1},{/if}  <!-- 使用索引和总长度判断 -->
                    {/foreach}
                ]
            }
        ]
    };
    sourceChart.setOption(sourceOption);

    // 窗口大小变化时重绘图表
    window.addEventListener('resize', function() {
        hourlyChart.resize();
        sourceChart.resize();
    });

    // 定时刷新数据（每5分钟）
    setInterval(function() {
        window.location.reload();
    }, 300000);
</script>
{/block}
{extend name="common/base" /}
{block name="content"}

<div class="panel panel-default panel-intro">
    <div class="panel-heading">
        {:build_heading(null, FALSE)}
        <div class="panel-lead">
            <em>{:__('Stock report generation and export')}</em>
        </div>
    </div>

    <div class="panel-body">
        <form class="form-inline" id="search-form">
            <div class="form-group">
                <label class="control-label">{:__('Report type')}</label>
                <select name="type" class="form-control" id="type">
                    <option value="daily" {:$type=='daily'?'selected':''}>{:__('Daily')}</option>
                    <option value="weekly" {:$type=='weekly'?'selected':''}>{:__('Weekly')}</option>
                    <option value="monthly" {:$type=='monthly'?'selected':''}>{:__('Monthly')}</option>
                    <option value="yearly" {:$type=='yearly'?'selected':''}>{:__('Yearly')}</option>
                </select>
            </div>
            <div class="form-group">
                <label class="control-label">{:__('Channel')}</label>
                <select name="channel" class="form-control" id="channel">
                    <option value="all" {:$channel=='all'?'selected':''}>{:__('All')}</option>
                    {foreach name="channelList" item="vo" key="k"}
                    <option value="{$k}" {:$channel==$k?'selected':''}>{$vo}</option>
                    {/foreach}
                </select>
            </div>
            <div class="form-group">
                <label class="control-label">{:__('Date range')}</label>
                <input type="text" class="form-control" name="date_range" value="{$start_date} - {$end_date}" id="date-range">
            </div>
            <button type="button" class="btn btn-primary" id="search-btn">{:__('Search')}</button>
            <button type="button" class="btn btn-success" id="export-excel">{:__('Export Excel')}</button>
            <button type="button" class="btn btn-info" id="export-pdf">{:__('Export PDF')}</button>
        </form>

        <div class="row" style="margin-top: 15px;">
            <div class="col-md-12">
                <div id="chart-container" style="height: 400px;"></div>
            </div>
        </div>

        <div class="row" style="margin-top: 15px;">
            <div class="col-md-12">
                <table id="report-table" class="table table-striped table-bordered table-hover table-nowrap">
                    <thead>
                    <tr>
                        <th>{:__('Date')}</th>
                        <th>{:__('Product name')}</th>
                        <th>{:__('Channel')}</th>
                        <th>{:__('Total stock')}</th>
                        <th>{:__('Used stock')}</th>
                        <th>{:__('Available stock')}</th>
                        <th>{:__('Usage rate')}</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 报表数据将通过JS动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="/assets/libs/echarts/echarts.min.js"></script>
<script>
    $(function () {
        // 初始化日期范围选择器
        $('#date-range').daterangepicker({
            format: 'YYYY-MM-DD',
            separator: ' - ',
            startDate: '{$start_date}',
            endDate: '{$end_date}'
        });

        // 初始化图表
        var chart = echarts.init(document.getElementById('chart-container'));

        // 搜索按钮点击事件
        $('#search-btn').click(function () {
            loadReportData();
        });

        // 导出按钮点击事件
        $('#export-excel').click(function () {
            exportReport('excel');
        });

        $('#export-pdf').click(function () {
            exportReport('pdf');
        });

        // 加载报表数据
        function loadReportData() {
            var type = $('#type').val();
            var channel = $('#channel').val();
            var dateRange = $('#date-range').val().split(' - ');
            var startDate = dateRange[0];
            var endDate = dateRange[1];

            $.ajax({
                url: "{:url('stock/getReportData')}",
                type: 'get',
                data: {
                    type: type,
                    channel: channel,
                    start_date: startDate,
                    end_date: endDate
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code == 0) {
                        // 更新表格数据
                        updateTableData(res.data.tableData);
                        // 更新图表数据
                        updateChartData(res.data.chartData);
                    } else {
                        layer.msg(res.msg);
                    }
                }
            });
        }

        // 更新表格数据
        function updateTableData(data) {
            var tbody = $('#report-table tbody');
            tbody.empty();

            if (data.length == 0) {
                tbody.append('<tr><td colspan="7" class="text-center">{:__('No data')}</td></tr>');
                return;
            }

            $.each(data, function (i, item) {
                var tr = '<tr>' +
                    '<td>' + item.date + '</td>' +
                    '<td>' + item.product_name + '</td>' +
                    '<td>' + item.channel_name + '</td>' +
                    '<td>' + item.total_stock + '</td>' +
                    '<td>' + item.used_stock + '</td>' +
                    '<td>' + (item.available_stock <= item.warn_value ? '<span style="color:red;">' + item.available_stock + '</span>' : item.available_stock) + '</td>' +
                    '<td>' + item.usage_rate + '%</td>' +
                    '</tr>';
                tbody.append(tr);
            });
        }

        // 更新图表数据
        function updateChartData(data) {
            var option = {
                title: {
                    text: '{:__('Stock Trend')}'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['{:__('Total stock')}', '{:__('Used stock')}', '{:__('Available stock')}']
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.categories
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: '{:__('Total stock')}',
                        type: 'bar',
                        data: data.totalStock
                    },
                    {
                        name: '{:__('Used stock')}',
                        type: 'bar',
                        data: data.usedStock
                    },
                    {
                        name: '{:__('Available stock')}',
                        type: 'line',
                        data: data.availableStock
                    }
                ]
            };

            chart.setOption(option);
        }

        // 导出报表
        function exportReport(format) {
            var type = $('#type').val();
            var channel = $('#channel').val();
            var dateRange = $('#date-range').val().split(' - ');
            var startDate = dateRange[0];
            var endDate = dateRange[1];

            var url = "{:url('stock/export')}?format=" + format +
                "&type=" + type +
                "&channel=" + channel +
                "&start_date=" + startDate +
                "&end_date=" + endDate;

            window.location.href = url;
        }

        // 初始加载数据
        loadReportData();
    });
</script>
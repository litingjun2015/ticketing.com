### 库存管理模块数据库设计

#### 1. 分时库存表（支持分时预约）
```sql
CREATE TABLE `fa_fzly_stock_time_slot` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `stock_id` int(10) unsigned NOT NULL COMMENT '关联库存ID',
  `ticket_type` varchar(30) NOT NULL COMMENT '票种',
  `channel` varchar(20) NOT NULL COMMENT '渠道类型',
  `date` date NOT NULL COMMENT '库存日期',
  `time_slot` varchar(20) NOT NULL COMMENT '时间段（如：上午/下午/全天）',
  `start_time` time NOT NULL COMMENT '开始时间',
  `end_time` time NOT NULL COMMENT '结束时间',
  `total_stock` int(10) NOT NULL DEFAULT 0 COMMENT '时段总库存',
  `used_stock` int(10) NOT NULL DEFAULT 0 COMMENT '时段已使用库存',
  `available_stock` int(10) NOT NULL DEFAULT 0 COMMENT '时段可用库存',
  `lock_stock` int(10) NOT NULL DEFAULT 0 COMMENT '时段锁定库存',
  `create_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '创建时间',
  `update_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_stock_time_slot` (`stock_id`,`time_slot`),
  KEY `idx_date_time_slot` (`date`,`time_slot`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分时库存表';
```

#### 2. 库存冻结日志表
```sql
CREATE TABLE `fa_fzly_stock_freeze_log` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `stock_id` int(10) unsigned NOT NULL COMMENT '库存ID',
  `time_slot_id` int(10) unsigned DEFAULT 0 COMMENT '分时库存ID（0表示不分时）',
  `order_id` varchar(50) NOT NULL COMMENT '订单号',
  `ticket_type` varchar(30) NOT NULL COMMENT '票种',
  `channel` varchar(20) NOT NULL COMMENT '渠道类型',
  `date` date NOT NULL COMMENT '库存日期',
  `freeze_num` int(10) NOT NULL COMMENT '冻结数量',
  `freeze_time` int(10) unsigned NOT NULL COMMENT '冻结时间',
  `expire_time` int(10) unsigned NOT NULL COMMENT '过期时间',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态（1:冻结中 2:已使用 3:已释放）',
  `release_time` int(10) unsigned DEFAULT 0 COMMENT '释放时间',
  `create_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '创建时间',
  `update_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_stock_id` (`stock_id`),
  KEY `idx_expire_status` (`expire_time`,`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='库存冻结日志表';
```

#### 3. 扩展库存预警配置表（增加比例预警）
```sql
ALTER TABLE `fa_system_setting_stock_warn` 
ADD COLUMN `warn_type` tinyint(1) NOT NULL DEFAULT 1 COMMENT '预警类型（1:固定值 2:百分比）' AFTER `warn_value`,
ADD COLUMN `warn_percent` decimal(5,2) DEFAULT 0.00 COMMENT '预警百分比（0-100）' AFTER `warn_type`;
```

#### 4. 扩展库存调整记录表（增加更多变动类型）
```sql
ALTER TABLE `fa_stock_adjust_log` 
MODIFY COLUMN `adjust_type` tinyint(2) NOT NULL COMMENT '调整类型（1:增加 2:减少 3:冻结 4:释放 5:初始设置）',
ADD COLUMN `time_slot` varchar(20) DEFAULT '' COMMENT '涉及时间段' AFTER `date`,
ADD COLUMN `order_id` varchar(50) DEFAULT '' COMMENT '关联订单号' AFTER `remark`;
```

### 测试数据SQL

#### 1. 分时库存测试数据
```sql
INSERT INTO `fa_fzly_stock_time_slot` 
(`stock_id`, `ticket_type`, `channel`, `date`, `time_slot`, `start_time`, `end_time`, `total_stock`, `used_stock`, `available_stock`, `lock_stock`, `create_time`, `update_time`) 
VALUES
(1, '成人票', '官网', '2024-07-01', '上午', '08:00:00', '12:00:00', 500, 180, 300, 20, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
(1, '成人票', '官网', '2024-07-01', '下午', '12:00:00', '18:00:00', 500, 170, 300, 30, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
(3, '儿童票', '官网', '2024-07-01', '全天', '08:00:00', '18:00:00', 500, 100, 380, 20, UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
```

#### 2. 库存冻结日志测试数据
```sql
INSERT INTO `fa_fzly_stock_freeze_log` 
(`stock_id`, `time_slot_id`, `order_id`, `ticket_type`, `channel`, `date`, `freeze_num`, `freeze_time`, `expire_time`, `status`, `release_time`, `create_time`, `update_time`) 
VALUES
(1, 1, 'ORD20240701001', '成人票', '官网', '2024-07-01', 2, UNIX_TIMESTAMP()-300, UNIX_TIMESTAMP()+600, 1, 0, UNIX_TIMESTAMP()-300, UNIX_TIMESTAMP()-300),
(1, 2, 'ORD20240701002', '成人票', '官网', '2024-07-01', 3, UNIX_TIMESTAMP()-1800, UNIX_TIMESTAMP()-900, 3, UNIX_TIMESTAMP()-900, UNIX_TIMESTAMP()-1800, UNIX_TIMESTAMP()-900),
(3, 0, 'ORD20240701003', '儿童票', '官网', '2024-07-01', 1, UNIX_TIMESTAMP()-600, UNIX_TIMESTAMP()+300, 1, 0, UNIX_TIMESTAMP()-600, UNIX_TIMESTAMP()-600);
```

#### 3. 更新库存预警配置测试数据
```sql
UPDATE `fa_system_setting_stock_warn` SET `warn_type`=1 WHERE `id` IN (1,2,3);

INSERT INTO `fa_system_setting_stock_warn`
(`channel`, `date_start`, `date_end`, `ticket_type`, `warn_value`, `warn_type`, `warn_percent`, `receivers`, `create_time`, `update_time`)
VALUES
('官网', '2024-07-01', '2024-07-31', '老人票', 0, 2, 10.00, '["13800138000"]', UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
```

### CRUD命令

```bash
# 分时库存表CRUD
php think crud -t fzly_stock_time_slot -c fzly/stock_time_slot -m fzly/StockTimeSlot -u 1

# 库存冻结日志表CRUD
php think crud -t fzly_stock_freeze_log -c fzly/stock_freeze_log -m fzly/StockFreezeLog -u 1
```

### 说明

1. 设计说明：
    - 新增`fa_fzly_stock_time_slot`表实现分时库存管理，支持按时间段分配库存
    - 新增`fa_fzly_stock_freeze_log`表跟踪库存冻结状态，支持超时自动释放
    - 扩展预警配置表支持固定值和百分比两种预警方式
    - 扩展库存调整日志表记录更多类型的库存变动

2. 功能覆盖：
    - 门票库存：通过主库存表+分时库存表实现总库存、每日库存和分时库存管理
    - 实时预警：支持固定值和百分比两种预警方式，沿用原有预警机制
    - 库存冻结：通过冻结日志表实现，可配合定时任务处理超时释放
    - 历史记录：调整日志表记录所有库存变动，支持多维度查询
    - 约束规则：在库存操作逻辑中添加库存检查，确保不超售

3. 页面风格：遵循要求参考指定页面风格，模板文件放在`admin\view\fzly\`目录下，可根据需要创建子目录如`admin\view\fzly\stock_time_slot\`